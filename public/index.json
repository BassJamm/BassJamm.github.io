[{"content":"Creating the Uninstall package Note that the download link to the McAfee Consumer Product Removal Tool will download the latest version. I had to download an older version I found from a reddit post for this to work; using the latest one is a bit hit and miss.\nDownload McAfee Consumer Product Removal Tool. Start the downloaded MCPR.exe and then Hold it open by not pressing next or close. While this dialog is open, navigate to the unpacked source files in, %localappdata%\\temp. Copy the folder MCPR to a suitable place for packageing, for example c:\\temp\\McAfeeRemover. Close the still open McAfee Software Removal tool by clicking cancel. Create a Powershell script in the folder above, for example C:\\temp\\McAfeeRemover\\McAfeeRemover.ps1. Create an IntuneWin package with the Microsoft Win32 Content Prep Tool Catalog files are used to enable Win32 apps in Windows 10 S mode, they are specific to Application Control which is the mechanism that S Mode uses to enforce and control applications.\nLots of details on this at https://docs.microsoft.com/en-us/mem/intune/apps/apps-win32-s-mode.\n","permalink":"http://localhost:1313/posts/december2024/uninstallmcafee/","summary":"Uninstall McAfee during Autopilot","title":"Uninstall McAfee"},{"content":"Intro Veeam Backup for Microsoft 365 is a reliable solution, but after years of use, I’ve identified areas for improvement. Key challenges include:\nBuilt-in Reporting Limited features often fall short of customer needs, requiring custom PowerShell scripts. Retention Periods: Difficult to audit, making it hard to track data outside of the backup retention window. SharePoint Script Issues: Pre-version 8, Microsoft\u0026rsquo;s security settings frequently disabled script execution. Group Ownership Gaps: Groups without owners aren\u0026rsquo;t backed up unless manually addressed. Backup Speed: Microsoft throttling significantly slows job completion times. Easy to lose control: We had various people\\teams look after this product, configuration drift has really left it in a mess in places. Below, I\u0026rsquo;m sharing what I have found, used and troubleshooted.\nTroubleshooting Scripts Checking the Last Backed up Time for an Object The notes below are for Item-Level Backups, which is based on the last modified date of the items within the backups (Emails, Files, Groups etc). Snapshot level backup retention works the same way accept you lose the whole snapshot not just the items.\nAn object is any one of the following item, User, Group, Site, Team, Organization, OneDrive, Mailbox. The script below helps identify when the object was last successfully backed up. Unfortunately, it does not identify which item in the backup is falling out of scope of the retention but, does give an idea of when items will start being removed from the backup job.\nFor example, in a SharePoint site, the file \u0026ldquo;Don\u0026rsquo;t Delete Me\u0026rdquo;, was last modified on the 1st of September 2021. If the retention is 3 years, the document would have been removed from the backups 4 months ago, but, other data in that site may have been edited in 2024 and so is still in scope of the retention.\nI went a bit mad on the Write-Host commands in this script but, the staff who\u0026rsquo;d be running this are not all savvy with Powershell so thought more information was better.\nReviewing the VBO Logs You can download the logs using the Veeam Console.\nOpen the Console. Click the Hamburger Menu in the top left. Select Help and Support. Select Support Information. With Collect Logs selected, Click next. Select the proxy server your job is running via. Save the logs to a good location and extract them. The script below doesn\u0026rsquo;t perform many complex actions; it simply removes some square brackets and creates separate date and time variables in their own columns. However, it simplifies the process, making it easier to continue searching, formatting, and exporting the logs from PowerShell.\nSome of the logs can be over 100,000 lines so there is a progress bar written into the foreach loop for some visual feedback.\nParsing Job Warnings and Errors It\u0026rsquo;s quite useful to be able to pull out any warnings or errors from the previous jobs. Below is a script that can help do that.\nThe starttime is optional, if you do not provide it, it will provide the most recent job matching the name you provide. Make sure to enter the starttime as a string like the example shows.\nRemoving a User\u0026rsquo;s License This process can be a bit of a pig, there is a Veeam Blog or KB post here.\nBest Practices Guide If you are looking for what Veeam suggest about how to setup and use this solution, there\u0026rsquo;s a guide here for version 7.\nJET Database Errors This will not be an issue once upgraded to version 8 as they have swapped over to Postgresql instead of JET.\nError Example Example error, 21/03/2024 20:28:39 :: Failed to process site: https://domain.sharepoint.com/sites/sitename. Unable to access repository (E:\\*VBOCacheName*\\PersistentCache\\repository.adb) JetError -1504, JET_errNullInvalid, Null not valid :: 0:03:27.\nSolution Raise a ticket with Veeam first—they’ll guide you in using eseutil.exe (a Microsoft tool for troubleshooting Exchange databases) to check database integrity.\nSteps we followed:\nRan an integrity check and repair. Deleted all cache files except the database, allowing Veeam to recreate them. Attempted another repair. Finally, we deleted the cache database and performed a re-sync. Since our database was only 80GB, this was completed within hours. They did warn me that this proess could take days if the .adb file is larger.\nI quote Veeam here, JET errors are notoriously hard to fix without a cache re-sync. They’re typically caused by a forcefully terminated open thread to the database, such as a server reboot.\nWarning: Possible team chat sync problem was detected An odd issue quickly fixed by Veeam Support: a mailbox tied to a Microsoft 365 group refused to back up, running for days without completing.\nVeeam advised against terminating jobs that are running outside the job Window and to allow atleast 2 retries for a job to minimise issues with throttling and JET based errors, see here for JET Errors.\nLog File snippet you should find 1 2 3 4 5 6 7 [05.08.2024 05:24:55.909] 68 (8380) Changed items: 0, deleted items: 0, read state changes: 100 [05.08.2024 05:24:55.909] 68 (8380) Warning: Possible team chat sync problem was detected [05.08.2024 05:24:55.914] 47 (5180) Processing mailbox: groupmailboxup@groups.domain.com... [05.08.2024 05:24:55.924] 47 (5180) Syncing folder items: Inbox... [05.08.2024 05:24:56.004] 47 (5180) Sync time: 0.0813057 [05.08.2024 05:24:56.004] 47 (5180) Changed items: 0, deleted items: 0, read state changes: 100 [05.08.2024 05:24:56.004] 47 (5180) Warning: Possible team chat sync problem was detected Fix Raise a ticket with Veeam first before going and doing anything yourself unless you are happy doing so.\nMake sure no jobs or restore sessions are running Stop the Veeam Backup for Microsoft 365 and Veeam Backup Proxy for Microsoft 365 services on the VBO 365 server and all backup proxies. Navigate to %ProgramData\\Veeam\\Backup365. Edit the proxy.xml file\u0026rsquo;s source line to include, FixTeamChatSync=\u0026quot;True\u0026quot;. 1 2 3 4 5 6 7 8 \u0026lt;Veeam\u0026gt; \u0026lt;Archiver\u0026gt; \u0026lt;Source FixTeamChatSync=\u0026#34;True\u0026#34; /\u0026gt; . . . \u0026lt;/Archiver\u0026gt; \u0026lt;/Veeam\u0026gt; Reporting As I mentioned to begin with, the reporting is one place that we have had to rely quite heavily on the Powershell commands for. Below are some examples.\nLicense Overview Report A simple set of commands that will give you the license overview report for all organisations in your VBO solution.\nHope this helps someone!\n","permalink":"http://localhost:1313/posts/december2024/veeambackupforms365/","summary":"Issues, Solutions, Notes and Reporting","title":"Veeam Backup For Microsoft 365"},{"content":" PaperMod Site. Call for Cloud Blog. Best Practice Guide for Veeam Backup for Microsoft 365 V7 ","permalink":"http://localhost:1313/external/","summary":"\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://adityatelange.github.io/hugo-PaperMod/\"\u003ePaperMod Site.\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://call4cloud.nl/\"\u003eCall for Cloud Blog.\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://bp.veeam.com/vb365/\"\u003eBest Practice Guide for Veeam Backup for Microsoft 365 V7\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e","title":"External Links"},{"content":"Collecting Autopilot Diagnostic Logs How to collect diagnostic logs from a device that is building currently or has been built.\nPress Shift + F10 or Fn + Shift + F10, to open Command Prompt. Type \u0026ldquo;PowerShell\u0026rdquo;, to launch the PowerShell prompt. Type , New-Item -Path C:\\ -Name Temp -ItemType Directory to create the destination folder for the logs. Type,Set-ExecutionPolicy -ExecutionPolicy Unrestricted to allow the script install later. Make sure your location is, \u0026quot;C:\\Windows\\System32\u0026quot;, if not type sl C:\\Windows\\System32\\. Run, MdmDiagnosticsTool.exe -area Autopilot -zip C:\\Temp\\mdmDiag.zip. Run, Install-Script -Name Get-AutopilotDiagnostics -Scope CurrentUser. Run, Get-AutopilotDiagnostics.ps1 -zip C:\\Temp\\mdmdiag.zip. Autopilot Process stuck How to check should your Autopilot build be stuck for long periods of time.\nFirstly, check the Autopilot Diagnostic Logs first using this section. If that gives you an application Id I would suggest using the section below for how to link that Id with the application.\nFinding an Application via it\u0026rsquo;s Id You\u0026rsquo;ll need to grab the application ID using this section first, then substitute your app Id into the url below.\nInclude the *, where they are now.\nhttps://endpoint.microsoft.com/#blade/Microsoft_Intune_Apps/SettingsMenu/2/appId/**appid**\nWorth noting that this method is a bit hit and miss. The alternative is to connect via PowerShell to your tenant. and generate your own report to collect the application Ids.\nDevice is assigned to a user You\u0026rsquo;ll see this when you try to complete the user driven method when the username is pre-populated at the initial login prompt. During pre-provision, where it confirms the Autopilot profile, you\u0026rsquo;ll see the user\u0026rsquo;s email address underneath it.\nCheck out this Microsoft doc for more information. Below is the condensed version.\nSign into the Microsoft Intune admin center. Navigate to Windows | Windows enrollment screen, under Windows Autopilot, select Devices. In the Windows Autopilot devices screen, locate the device to assign a user to. Once the desired device is located, select the box to the left of the device, making sure that there\u0026rsquo;s check mark in the box, and then select Assign user in the toolbar at the top of page. Clear the user from here and click Save. Reboot the device (maybe once or twice) and the user should no longer appear. Hardware Error during Pre-Provision More errors will be added as and when I find them.\nAutopilot securing your hardware 0x800705b4 PowerShell script to troubleshoot TPM attestation issues\ntpmtool getdeviceinformation - Gets basic TPM information.\nConfirm Attestation Readiness Powershell Gallery Link\nRun Command Prompt as an admin. Run the commands below. 1 2 3 4 5 6 7 8 9 # Install the module Install-Module -Name Autopilottestattestation -force # Set the exetion policy set-executionpolicy unrestricted # Import the module import-module -Name Autopilottestattestation # Run the report # Say yes to checking for updates. test-autopilotattestation Continue on below if you find errors or if you find no errors.\nReset the Device to Factory Make sure to delete from MDM (not EntraID or Autopilot)\nReset the device from the error page from Pre-provisioning, let this complete.\nThere is a command for PowerShell for a Windows 11 device, systemreset --factoryreset\nTry Pre-Provision again.\nClear the TPM Chip There is always a small chance you could bork the machine doing this, don\u0026rsquo;t do it without considering this.\nOpen command prompt as an admin. Type, Clear-Tpm. Run the command, tpmtool getdeviceinformation command to ascertain TPM health, Tool information. Try the build again. Escalate to Microsoft You\u0026rsquo;ve tried everything so far to no end. Now to raise to Microsoft.\n","permalink":"http://localhost:1313/posts/december2024/diagnosing-autopilot-issues/","summary":"Diagnosing Autopilot Issues for Windows Devices","title":"Diagnosing Autopilot Issues for Windows Devices"}]